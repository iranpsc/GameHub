<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Windows Launcher Agent</title>
<style>
body { font-family: system-ui, Arial, sans-serif; padding: 20px; max-width: 820px; margin: auto; }
h2 { margin: 0 0 12px; }
.row { margin: 8px 0; }
.app { display: flex; align-items: center; justify-content: space-between; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 8px 0; }
.app small { color: #666; }
button { padding: 10px 14px; }
</style>
</head>
<body>
  <h2>Windows Launcher Agent</h2>
  <div class="row">Status: <span id="status">loading…</span></div>
  <div class="row">
    <label>Launch token (optional): <input id="token" type="password" placeholder="x-launch-token header" /></label>
    <button id="saveToken">Save</button>
  </div>

  <div id="apps">Loading apps…</div>

<script>
const statusEl = document.getElementById('status');
const appsEl = document.getElementById('apps');
const tokenInput = document.getElementById('token');
const saved = localStorage.getItem('launchToken') || '';
tokenInput.value = saved || '';

document.getElementById('saveToken').onclick = () => {
  localStorage.setItem('launchToken', tokenInput.value || '');
  alert('Saved token');
};

async function getHeaders() {
  const headers = { 'Content-Type': 'application/json' };
  const token = localStorage.getItem('launchToken') || '';
  if (token) headers['x-launch-token'] = token;
  return headers;
}

async function refreshStatus() {
  try {
    const res = await fetch('/health');
    const json = await res.json();
    statusEl.textContent = json.status + ' (' + json.platform + ')';
  } catch (e) {
    statusEl.textContent = 'offline';
  }
}

async function loadApps() {
  appsEl.innerHTML = 'Loading apps…';
  try {
    const res = await fetch('/apps');
    const json = await res.json();
    const items = json.apps || [];
    appsEl.innerHTML = '';

    for (const a of items) {
      const div = document.createElement('div');
      div.className = 'app';

      const left = document.createElement('div');
      left.innerHTML = '<strong>' + a.name + '</strong><br/><small>' + a.path + '</small>';

      const btn = document.createElement('button');
      btn.textContent = 'Launch';
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = 'Launching…';
        try {
          const res = await fetch('/launch', {
            method: 'POST',
            headers: await getHeaders(),
            body: JSON.stringify({ appId: a.id })
          });
          const ok = res.status === 202;
          const json = await res.json().catch(() => ({}));
          alert(ok ? ('Launched ' + a.name) : ('Error: ' + (json.error || res.status)));
        } catch (e) {
          alert('Failed: ' + e);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Launch';
        }
      };

      div.appendChild(left);
      div.appendChild(btn);
      appsEl.appendChild(div);
    }
  } catch (e) {
    appsEl.textContent = 'Failed to load apps';
  }
}

refreshStatus();
loadApps();
</script>
</body>
</html>